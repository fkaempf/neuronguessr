<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Guess where neurons belong in the fly brain. A GeoGuessr-style 3D neuroscience game.">
    <meta property="og:title" content="NeuronGuessr">
    <meta property="og:description" content="Guess where neurons belong in the fly brain. A GeoGuessr-style 3D neuroscience game.">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#0f0f23">
    <link rel="icon" type="image/svg+xml" href="neuronguessr.svg">
    <title>NeuronGuessr</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Start Screen -->
    <div id="screen-start" class="screen active">
        <div class="start-content">
            <h1 class="title">NeuronGuessr</h1>
            <p class="subtitle">Can you locate neurons in the fly brain?</p>
            <p class="description">
                You'll see a 3D neuron mesh. Rotate it, study its shape,
                then guess where in the brain it belongs and how many synapses it has.
            </p>
            <div class="start-info">
                <div class="info-item">
                    <span class="info-number">5</span>
                    <span class="info-label">Rounds</span>
                </div>
                <div class="info-item">
                    <span class="info-number">10K</span>
                    <span class="info-label">Max pts/round</span>
                </div>
                <div class="info-item">
                    <span class="info-number">50K</span>
                    <span class="info-label">Perfect score</span>
                </div>
            </div>
            <div id="auth-section" class="auth-section">
                <div id="auth-not-signed-in" class="token-tutorial">
                    <p class="tutorial-intro">
                        This game uses live neuron data from
                        <a href="https://neuprint.janelia.org" target="_blank" rel="noopener">neuPrint</a>,
                        a database of the <em>Drosophila</em> connectome. You'll need a free API token to play.
                    </p>
                    <ol class="tutorial-steps">
                        <li>Go to <a href="https://neuprint.janelia.org/account" target="_blank" rel="noopener">neuprint.janelia.org/account</a> and sign in with Google</li>
                        <li>Copy the <strong>AUTH_TOKEN</strong> shown on the page</li>
                        <li>Paste it below</li>
                    </ol>
                    <div class="token-input-row">
                        <input type="password" id="neuprint-token" placeholder="Paste your neuPrint API token" class="token-input">
                        <button id="btn-set-token" class="btn-token-set">Set Token</button>
                    </div>
                </div>
                <div id="auth-signed-in" class="auth-status" style="display:none;">
                    <span class="auth-badge">Authenticated</span>
                    <span id="auth-email" class="auth-email"></span>
                    <button id="btn-sign-out" class="btn-link">Sign out</button>
                </div>
            </div>

            <div class="mode-selector" id="mode-selector">
                <button id="btn-daily" class="btn-mode" disabled>
                    <span class="mode-title">Daily Challenge</span>
                    <span class="mode-desc">Today's 5 neurons &middot; Compare scores</span>
                    <span id="daily-date" class="mode-date"></span>
                </button>
                <button id="btn-freeplay" class="btn-mode" disabled>
                    <span class="mode-title">Free Play</span>
                    <span class="mode-desc">Random neurons every time</span>
                </button>
            </div>
            <div id="daily-status-row" class="daily-status-row" style="display:none;">
                <p id="daily-status" class="daily-status"></p>
                <button id="btn-share-start" class="btn-share-start">Share</button>
            </div>

            <button id="btn-scoring" class="btn-link">How Scoring Works</button>
            <p class="privacy-note">
                Your API token is sent only to neuPrint (via our <a href="https://github.com/fkaempf/neuronguessr/blob/main/cors-proxy/worker.js" target="_blank" rel="noopener">open-source CORS proxy</a>) and stored in your browser's local storage. It is never logged or shared.
            </p>
            <p class="credit">
                Data: <em>Drosophila</em> Male CNS Connectome via <a href="https://neuprint.janelia.org" target="_blank" rel="noopener">neuPrint</a> &amp; <a href="https://github.com/janelia-flyem/dvid" target="_blank" rel="noopener">DVID</a>
                <button id="btn-info-toggle" class="info-toggle" aria-label="Show tech info" title="Tech info">i</button>
            </p>
            <div id="tech-stack" class="tech-stack" style="display:none;">
                3D neuron meshes from <a href="https://github.com/janelia-flyem/dvid" target="_blank" rel="noopener">DVID</a> (neuroglancer precomputed format) &middot;
                Synapse counts &amp; metadata queried live from <a href="https://neuprint.janelia.org" target="_blank" rel="noopener">neuPrint</a> via Cypher &middot;
                Brain neuropil meshes from static OBJ/PLY files &middot;
                Rendered with <a href="https://threejs.org" target="_blank" rel="noopener">Three.js</a> &middot; Vanilla JS &middot; No build step
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="screen-loading" class="screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">Loading brain meshes...</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="screen">
        <!-- Top bar -->
        <div id="game-hud">
            <span id="round-counter">Round 1 / 5</span>
            <span id="total-score">Score: 0</span>
        </div>

        <!-- Mobile panel toggle -->
        <div id="mobile-panel-toggle" class="mobile-panel-toggle">
            <button id="btn-show-neuron" class="toggle-btn active">Neuron</button>
            <button id="btn-show-brain" class="toggle-btn">Brain</button>
        </div>

        <!-- Split panel -->
        <div id="game-panels">
            <!-- Left: Neuron viewer -->
            <div id="panel-neuron" class="panel">
                <div id="neuron-canvas-container" class="canvas-container"></div>
                <div class="panel-label">
                    Mystery Neuron <span class="hint">(drag to rotate)</span>
                    <button id="btn-reset-neuron" class="btn-small">Reset View</button>
                </div>
            </div>

            <!-- Right: Brain guess panel -->
            <div id="panel-brain" class="panel">
                <div id="brain-canvas-container" class="canvas-container"></div>
                <div class="panel-label">
                    <span class="panel-label-desktop">Click to place guess, Shift+scroll to adjust depth</span>
                    <span class="panel-label-mobile">Tap to place guess</span>
                    <span id="guess-coords" class="coords-display"></span>
                    <button id="btn-toggle-roi" class="btn-small">Show Brain Regions</button>
                    <button id="btn-toggle-ortho" class="btn-small">Perspective View</button>
                    <button id="btn-reset-view" class="btn-small">Reset View</button>
                </div>
            </div>
        </div>

        <!-- Bottom action bar -->
        <div id="game-actions">
            <div id="depth-slider-row" class="depth-slider-row" style="display:none;">
                <label class="depth-label">Depth:</label>
                <input type="range" id="depth-slider" min="-500" max="500" value="0" step="1">
            </div>
            <div class="synapse-guess-row">
                <label class="synapse-label" for="synapse-slider">Synapses:</label>
                <input type="range" id="synapse-slider" min="0" max="1000" value="500" step="1">
                <input type="text" id="synapse-value" class="synapse-value" inputmode="numeric" value="1,000">
            </div>
            <button id="btn-submit" class="btn-primary" disabled>Submit Guess</button>
        </div>
    </div>

    <!-- Round Result -->
    <div id="screen-result" class="screen">
        <div id="game-hud-result" class="game-hud-clone">
            <span id="round-counter-result"></span>
            <span id="total-score-result"></span>
        </div>
        <div id="result-layout">
            <div id="result-brain-panel" class="panel">
                <div id="result-brain-container" class="canvas-container"></div>
            </div>
            <div id="result-info-panel">
                <div class="result-card">
                    <h2 id="result-title">Round 1 Result</h2>
                    <div id="result-score" class="big-score">0</div>
                    <div class="result-score-breakdown">
                        <span id="result-loc-score" class="sub-score">Location: 0</span>
                        <span id="result-syn-score" class="sub-score">Synapses: 0</span>
                    </div>
                    <div class="result-details">
                        <div class="detail-row">
                            <span class="detail-label">Distance</span>
                            <span id="result-distance" class="detail-value">0 um</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Synapses (yours / actual)</span>
                            <span id="result-synapses" class="detail-value">- / -</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Neuron Type</span>
                            <span id="result-type" class="detail-value">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Brain Region</span>
                            <span id="result-region" class="detail-value">-</span>
                        </div>
                    </div>
                    <p class="result-hint">
                        <span class="marker-legend guess-dot"></span> Your guess
                        <span class="marker-legend answer-dot"></span> Actual location
                        <span class="marker-legend neuron-color"></span> Neuron
                    </p>
                    <button id="btn-next" class="btn-primary">Next Round</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scoring Info Overlay -->
    <div id="screen-scoring" class="screen overlay">
        <div class="scoring-card">
            <h2>How Scoring Works</h2>
            <div class="scoring-section">
                <h3>Location <span class="scoring-max">max 5,000 pts</span></h3>
                <p class="scoring-formula">5000 &times; e<sup>&minus;(6.6 &times; d / D)&sup2;</sup></p>
                <p class="scoring-desc">d = distance to actual position, D = brain diagonal (~1,050 &micro;m)</p>
                <canvas id="chart-location" width="400" height="180"></canvas>
            </div>
            <div class="scoring-section">
                <h3>Synapses <span class="scoring-max">max 5,000 pts</span></h3>
                <p class="scoring-formula">5000 &times; e<sup>&minus;1.5 &times; |ln(guess / actual)|</sup></p>
                <p class="scoring-desc">Log-ratio: being 2x off costs the same at 100 or 100,000 synapses</p>
                <canvas id="chart-synapse" width="400" height="180"></canvas>
            </div>
            <button id="btn-close-scoring" class="btn-primary">Got it</button>
        </div>
    </div>

    <!-- Final Score Screen -->
    <div id="screen-final" class="screen">
        <div id="final-layout">
            <div id="final-brain-panel" class="panel">
                <div id="final-brain-container" class="canvas-container"></div>
                <div class="panel-label">
                    All guesses overview
                    <span class="hint">&mdash; <span class="marker-legend guess-dot"></span> guess <span class="marker-legend answer-dot"></span> actual</span>
                </div>
            </div>
            <div id="final-info-panel">
                <div class="final-card">
                    <h1>Game Over</h1>
                    <div id="final-score" class="big-score">0</div>
                    <button id="btn-share" class="btn-share" style="display:none;">Share</button>
                    <p class="final-subtitle">out of 50,000</p>
                    <div id="round-breakdown"></div>
                    <div id="score-submit-row" class="score-submit-row">
                        <input type="text" id="player-name" class="player-name-input" placeholder="Your name" maxlength="20">
                        <button id="btn-submit-score" class="btn-primary btn-submit-score">Submit Score</button>
                    </div>
                    <div id="leaderboard-section" class="leaderboard-section" style="display:none;">
                        <h3 class="leaderboard-title">Leaderboard</h3>
                        <div id="leaderboard-container"></div>
                        <canvas id="histogram-canvas" class="histogram-canvas" width="400" height="120"></canvas>
                    </div>
                    <button id="btn-replay" class="btn-primary">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="js/main.js"></script>
</body>
</html>
